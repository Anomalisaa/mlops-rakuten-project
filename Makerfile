.PHONY: uv set-dvc init-git init-dvc build run track dvc-docto all

# Installiere das uv-Tool (von Astral)
uv:
	curl -LsSf https://astral.sh/uv/install.sh | sh

# Konfiguriere den DVC Remote mithilfe der Umgebungsvariablen
set-dvc:
	dvc remote add origin s3://dvc
	dvc remote modify origin endpointurl https://dagshub.com/BeritM/mlops-rakuten-project.s3
	dvc remote modify origin --local access_key_id $(DVC_USER)
	dvc remote modify origin --local secret_access_key $(DVC_PASSWORD)
	dvc remote default origin

# Initialisiere ein neues Git-Repository und committe die initiale Struktur
init-git:
	git init
	git add .gitignore Dockerfile docker-compose.yml dvc.yaml src/
	git commit -m "Initial project structure and pipeline definition"

# Initialisiere DVC und committe die DVC-Konfigurationsdateien
init-dvc:
	dvc init
	git add .dvc/config .dvc/.gitignore
	git commit -m "Initialize DVC"

# Baue die Docker Compose Services
build:
	docker compose build

# Führe die Pipeline im dedizierten dvc-runner Service aus
run:
	docker compose run --rm dvc-runner dvc repro

# Verfolge Änderungen: committe Updates in Git, committe DVC-Änderungen und pushe sie
track:
	git add .
	git commit -m "updating the run"
	dvc commit
	git push
	dvc push

# Führe einen DVC-Diagnose-Check über den dvc-runner Service aus
dvc-docto:
	docker compose run --rm dvc-runner dvc doctor

# Führe alle wesentlichen Schritte nacheinander aus
all: init-git init-dvc build run
